<div class="admin-page-content">
    <div class="selection-card glass">
        <h3><i class="fa-solid fa-filter"></i> Select Batch</h3>
        <div class="form-group">
            <label>Choose a batch to see enrolled students</label>
            <select [(ngModel)]="selectedBatchId" (change)="onBatchChange()">
                <option [ngValue]="null" disabled selected>-- Select a Batch --</option>
                <option *ngFor="let b of batches()" [ngValue]="b.id">{{ b.name }} ({{ b.timing }})</option>
            </select>
        </div>

        <div class="form-group mt-15" *ngIf="selectedBatchId && students().length > 0">
            <label><i class="fa-solid fa-search"></i> Search Students</label>
            <input type="text" [ngModel]="searchQuery()" (ngModelChange)="searchQuery.set($event)"
                placeholder="Filter by name, email, or username...">
        </div>
    </div>

    <div *ngIf="error()" class="feedback-banner error">
        <i class="fa-solid fa-exclamation-circle"></i>
        {{ error() }}
    </div>

    <section class="dash-list glass mt-30">
        <h3><i class="fa-solid fa-users"></i> Enrolled Students</h3>

        <div *ngIf="loading()" class="loading-state">
            <i class="fa-solid fa-spinner fa-spin"></i>
            <p>Loading students...</p>
        </div>

        <div class="table-container" *ngIf="!loading()">
            <table>
                <thead>
                    <tr>
                        <th>Student Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Username</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let s of filteredStudents()">
                        <td>{{ s.name }}</td>
                        <td>{{ s.email }}</td>
                        <td>{{ s.phone }}</td>
                        <td><code>{{ s.username }}</code></td>
                        <td>
                            <span class="status-pill" [class.active]="s.active" [class.inactive]="!s.active">
                                {{ s.active ? 'Active' : 'Inactive' }}
                            </span>
                        </td>
                        <td>
                            <div class="action-group">
                                <button class="action-btn edit" (click)="openEdit(s)" title="Edit Student">
                                    <i class="fa-solid fa-pen-to-square"></i> Edit
                                </button>
                                <button class="action-btn" [class.inactive-btn]="s.active"
                                    [class.active-btn]="!s.active" (click)="toggleStatus(s)"
                                    [title]="s.active ? 'Deactivate Student' : 'Activate Student'">
                                    <i class="fa-solid" [class.fa-user-slash]="s.active"
                                        [class.fa-user-check]="!s.active"></i>
                                    {{ s.active ? 'Inactive' : 'Active' }}
                                </button>
                                <button class="action-btn delete" (click)="deleteStudent(s)" title="Delete Student">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    <tr *ngIf="students().length === 0 && selectedBatchId && !loading()">
                        <td colspan="6" class="empty">No students enrolled in this batch yet.</td>
                    </tr>
                    <tr *ngIf="filteredStudents().length === 0 && students().length > 0 && searchQuery() && !loading()">
                        <td colspan="6" class="empty">No students match your search criteria.</td>
                    </tr>
                    <tr *ngIf="!selectedBatchId">
                        <td colspan="6" class="empty">Please select a batch from above.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>

    <!-- Edit Modal -->
    <div class="modal-overlay" *ngIf="editingStudent()" (click)="closeEdit()">
        <div class="modal-content glass" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3><i class="fa-solid fa-user-edit"></i> Edit Student</h3>
                <button class="close-btn" (click)="closeEdit()">&times;</button>
            </div>

            <form [formGroup]="editForm" (ngSubmit)="onUpdateSubmit()">
                <div class="form-row">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" formControlName="name" placeholder="Enter full name">
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="text" formControlName="phone" placeholder="Enter phone number">
                    </div>
                </div>

                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" formControlName="email" placeholder="Enter email address">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Batch</label>
                        <select formControlName="batchId">
                            <option *ngFor="let b of batches()" [ngValue]="b.id">{{ b.name }} ({{ b.timing }})</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Account Status</label>
                        <select formControlName="active">
                            <option [ngValue]="true">Active</option>
                            <option [ngValue]="false">Inactive</option>
                        </select>
                    </div>
                </div>

                <div class="auth-box glass">
                    <h4>Reset Password (Optional)</h4>
                    <div class="form-group">
                        <label>New Password</label>
                        <div class="input-wrapper">
                            <input [type]="showPassword() ? 'text' : 'password'" formControlName="password"
                                placeholder="Leave blank to keep current">
                            <button type="button" class="eye-btn" (click)="showPassword.set(!showPassword())">
                                <i class="fa-solid" [class.fa-eye]="!showPassword()"
                                    [class.fa-eye-slash]="showPassword()"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="dash-btn outline" (click)="closeEdit()">Cancel</button>
                    <button type="submit" class="dash-btn" [disabled]="editForm.invalid || isUpdating()">
                        <span *ngIf="!isUpdating()">Save Changes</span>
                        <span *ngIf="isUpdating()"><i class="fa-solid fa-spinner fa-spin"></i> Updating...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>